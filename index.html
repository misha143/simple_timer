<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–∞–π–º–µ—Ä</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
  <style>
    /* --- –°–±—Ä–æ—Å –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ --- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg_color: #f8fafc;
      --card_bg: #ffffff;
      --text_main: #0f172a;
      --text_muted: #64748b;
      --accent_color: #6366f1;
      --accent_hover: #4f46e5;
      --success_color: #10b981;
      --danger_color: #ef4444;
      --border_color: #e2e8f0;
      --shadow_lg: 0 10px 15px -3px rgba(0,0,0,0.1);
      --radius: 20px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg_color: #020617;
        --card_bg: #1e293b;
        --text_main: #f1f5f9;
        --text_muted: #94a3b8;
        --border_color: #334155;
      }
    }

    .page_body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg_color);
      color: var(--text_main);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      transition: background-color 0.3s ease;
    }

    /* --- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã --- */
    .timer_card {
      background-color: var(--card_bg);
      padding: 32px;
      border-radius: var(--radius);
      box-shadow: var(--shadow_lg);
      border: 1px solid var(--border_color);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .timer_title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text_muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 24px;
    }

    /* –°–µ–∫—Ü–∏—è –≤–≤–æ–¥–∞ */
    .inputs_row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .input_unit {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field_label {
      font-size: 12px;
      color: var(--text_muted);
      font-weight: 600;
    }

    .number_input {
      width: 80px;
      padding: 12px;
      border: 2px solid var(--border_color);
      border-radius: 12px;
      background: transparent;
      color: var(--text_main);
      font-size: 20px;
      text-align: center;
      font-weight: 600;
      outline: none;
    }

    .number_input:focus {
      border-color: var(--accent_color);
    }

    .input_separator {
      font-size: 24px;
      font-weight: 700;
      color: var(--border_color);
      margin-top: 20px;
    }

    /* –¢–∞–±–ª–æ */
    .time_display {
      margin-bottom: 32px;
    }

  .time_numbers {
    font-family: 'Roboto Mono', monospace; /* –ó–∞–º–µ–Ω–∞ —à—Ä–∏—Ñ—Ç–∞ –Ω–∞ Mono */
    font-size: 80px;
    font-weight: 700;
    line-height: 1;
  }

  /* –°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π –ø–æ–¥ —Ç–∞–π–º–µ—Ä–æ–º */
  .today_sessions {
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px dashed var(--border_color);
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
  }
  .session_item {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 10px;
    color: var(--text_muted);
    position: relative;
  }
  .session_check { font-size: 20px; cursor: default; }
  .del_btn {
    position: absolute;
    top: -5px; right: -5px;
    background: var(--danger_color);
    color: white;
    border-radius: 50%;
    width: 14px; height: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 8px; cursor: pointer; border: none;
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è —ç–º–æ–¥–∑–∏ */
  .flying-emoji {
    position: fixed;
    bottom: 50%;
    left: 50%;
    font-size: 50px;
    z-index: 9999;
    pointer-events: none;
    animation: flyUpAndFade 1.5s ease-out forwards;
  }
  @keyframes flyUpAndFade {
    0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
    30% { transform: translate(-50%, -100px) scale(1.2); opacity: 1; }
    100% { transform: translate(-50%, -250px) scale(1); opacity: 0; }
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –ò—Å—Ç–æ—Ä–∏–∏ */
  .history_overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg_color); z-index: 100;
    padding: 20px; overflow-y: auto; display: none;
  }
  .history_layout {
    display: flex;
    gap: 30px;
    flex-wrap: wrap; /* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
  }
  #history_content { flex: 1; min-width: 300px; }
  #history_chart { flex: 1; min-width: 300px; height: 400px; }
  .history_header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .history_day { margin-bottom: 15px; text-align: left; }
  .view_history_btn { margin-top: 15px; font-size: 12px; color: var(--accent_color); cursor: pointer; text-decoration: underline; }

    /* –ö–Ω–æ–ø–∫–∏ */
    .controls_layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .btn {
      padding: 16px;
      border: none;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:active {
      transform: scale(0.96);
    }

    .btn_full {
      grid-column: span 2;
    }

    .btn_primary {
      background-color: var(--accent_color);
      color: white;
    }

    .btn_outline {
      background-color: transparent;
      border: 2px solid var(--border_color);
      color: var(--text_main);
    }

    .btn_success {
      background-color: var(--success_color);
      color: white;
    }

    .is_hidden {
      display: none !important;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

</head>
<body class="page_body">

  <main class="timer_card">
    <div class="timer_title">Simple Timer</div>

    <!-- –í–≤–æ–¥ –º–∏–Ω—É—Ç –∏ —Å–µ–∫—É–Ω–¥ -->
    <div class="inputs_row" id="setup_ui">
      <div class="input_unit">
        <label class="field_label">–ú–∏–Ω</label>
        <input type="number" id="inp_min" class="number_input" value="25" min="0" max="999">
      </div>
      
      <div class="input_separator">:</div>

      <div class="input_unit">
        <label class="field_label">–°–µ–∫</label>
        <input type="number" id="inp_sec" class="number_input" value="0" min="0" max="59">
      </div>
    </div>

    <!-- –¢–∞–±–ª–æ -->
    <div class="time_display">
      <span class="time_numbers" id="display_val">25:00</span>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="controls_layout">
      <button id="btn_main" class="btn btn_primary btn_full">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
      <button id="btn_reset" class="btn btn_outline is_hidden">–°–±—Ä–æ—Å</button>
      <button id="btn_restart" class="btn btn_outline is_hidden">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      <button id="btn_ok" class="btn btn_success btn_full is_hidden">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–≤—É–∫ (–û–ö)</button>
    </div>

    <div id="focus_stats" style="margin-top: 24px; font-size: 14px; font-weight: 600;"></div>
    <div id="today_list" class="today_sessions"></div>
    <!-- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ -->
    <div class="view_history_btn" style="margin-bottom: 8px;" onclick="toggleManual(true)">–î–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é</div>
    <div class="view_history_btn" onclick="toggleHistory(true)">–ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –¥–Ω–µ–π</div>
  </main>

  <!-- –û–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ -->
  <div id="history_modal" class="history_overlay">
    <div class="history_header">
      <div style="display: flex; flex-direction: column; gap: 4px;">
        <h2>–ò—Å—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π</h2>
        <div style="display: flex; gap: 10px;">
          <span class="view_history_btn" onclick="exportSessions()">–≠–∫—Å–ø–æ—Ä—Ç JSON</span>
          <span class="view_history_btn" onclick="document.getElementById('import_file').click()">–ò–º–ø–æ—Ä—Ç JSON</span>
          <input type="file" id="import_file" style="display:none" accept=".json" onchange="importSessions(event)">
        </div>
      </div>
      <button class="btn btn_outline" onclick="toggleHistory(false)">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="history_layout">
      <div id="history_content"></div>
      <div id="history_chart"></div>
    </div>
  </div>


  <script>
    function formatMinutes(totalMinutes) {
  const h = Math.floor(totalMinutes / 60);
  const m = totalMinutes % 60;
  return h > 0 ? `${h} —á ${m} –º–∏–Ω` : `${m} –º–∏–Ω`;
}

    // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    let config = {
      total_seconds: 0,
      current_seconds: 0,
      timer_interval: null,
      is_active: false,
      is_paused: false,
      audio_ctx: null,
      audio_interval: null
    };

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const el = {
      min: document.getElementById('inp_min'),
      sec: document.getElementById('inp_sec'),
      display: document.getElementById('display_val'),
      btn_main: document.getElementById('btn_main'),
      btn_reset: document.getElementById('btn_reset'),
      btn_restart: document.getElementById('btn_restart'),
      btn_ok: document.getElementById('btn_ok'),
      setup_ui: document.getElementById('setup_ui')
    };

    // –ó–≤—É–∫–æ–≤—ã–µ —Ñ–∞–π–ª—ã
    const soundGo = new Audio('go.mp3');
    const soundWin = new Audio('terwin.mp3');

    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
     */
    function update_view(s) {
      const mins = Math.floor(s / 60);
      const secs = s % 60;
      const formatted = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      el.display.textContent = formatted;
      
      if (config.is_active && !config.is_paused) {
        document.title = `(${formatted}) –¢–∞–π–º–µ—Ä`;
      } else if (config.is_paused) {
        document.title = `[–ü–∞—É–∑–∞] ${formatted}`;
      } else {
        document.title = '–¢–∞–π–º–µ—Ä';
      }
    }

    /**
     * –ó–≤—É–∫ —á–µ—Ä–µ–∑ Web Audio API
     */
    function play_beep() {
      if (!config.audio_ctx) config.audio_ctx = new (window.AudioContext || window.webkitAudioContext)();
      
      if (config.audio_ctx.state === 'suspended') {
        config.audio_ctx.resume();
      }

      const beep = () => {
        const osc = config.audio_ctx.createOscillator();
        const gain = config.audio_ctx.createGain();
        osc.connect(gain);
        gain.connect(config.audio_ctx.destination);
        osc.frequency.value = 660;
        gain.gain.setValueAtTime(0.1, config.audio_ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, config.audio_ctx.currentTime + 0.6);
        osc.start();
        osc.stop(config.audio_ctx.currentTime + 0.6);
      };

      beep();
      config.audio_interval = setInterval(beep, 1200);
    }

    /**
     * –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—á–µ–º —Å—Ç–æ–ª–µ
     */
    function send_notification() {
      if (Notification.permission === 'granted') {
        const n = new Notification('–í—Ä–µ–º—è –≤—ã—à–ª–æ!', {
          body: '–ó–∞–∫—Ä–æ–π—Ç–µ —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Äî –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–µ–≥–æ üëÜ',
          requireInteraction: true, // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –∏—Å—á–µ–∑–Ω–µ—Ç —Å–∞–º–æ
          silent: true // –ú—ã —Å–∞–º–∏ –∏–≥—Ä–∞–µ–º –∑–≤—É–∫ —á–µ—Ä–µ–∑ Web Audio API
        });

        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –Ω–∞ —Å–∞–º–æ —Ç–µ–ª–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        n.onclick = () => {
          window.focus();
          triggerEmojiAnimation();
          stop_everything();
          n.close();
        };

        // –ï–°–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ê–ñ–ê–õ –ù–ê –ö–†–ï–°–¢–ò–ö (–∑–∞–∫—Ä—ã–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)
        n.onclose = () => {
          stop_everything();
        };
      }
    }

    /**
     * –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ç–∞–π–º–µ—Ä–∞
     */
    function start() {
      clearInterval(config.timer_interval);
      if (!config.is_paused) {
        const m = parseInt(el.min.value) || 0;
        const s = parseInt(el.sec.value) || 0;
        config.total_seconds = (m * 60) + s;
        config.current_seconds = config.total_seconds;
        
        if (config.total_seconds <= 0) return;

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —Å—Ç–∞—Ä—Ç–∞
        soundGo.play().catch(e => console.log("Audio play blocked"));
        
        // –ó–∞–ø—Ä–æ—Å –ø—Ä–∞–≤ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        if (Notification.permission !== 'granted') {
          Notification.requestPermission();
        }
      }

      config.is_active = true;
      config.is_paused = false;
      
      el.btn_main.textContent = '–ü–∞—É–∑–∞';
      el.btn_main.classList.replace('btn_primary', 'btn_outline');
      el.setup_ui.classList.add('is_hidden');
      el.btn_reset.classList.remove('is_hidden');
      el.btn_restart.classList.remove('is_hidden');

      config.timer_interval = setInterval(() => {
        config.current_seconds--;
        update_view(config.current_seconds);

        if (config.current_seconds <= 0) {
          finish();
        }
      }, 1000);
    }

    function pause() {
      clearInterval(config.timer_interval);
      config.is_paused = true;
      el.btn_main.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
      el.btn_main.classList.replace('btn_outline', 'btn_primary');
      update_view(config.current_seconds);
    }

function finish() {
      clearInterval(config.timer_interval);
      config.is_active = false;
      saveSessionRecord(); 
      
      // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –ø–æ–±–µ–¥–Ω—ã–π –∑–≤—É–∫ –æ–¥–∏–Ω —Ä–∞–∑
      soundWin.play().catch(e => console.log("Audio play blocked"));
      
      play_beep();
      send_notification();
      
      el.btn_main.classList.add('is_hidden');
      el.btn_reset.classList.add('is_hidden');
      el.btn_restart.classList.add('is_hidden');
      el.btn_ok.classList.remove('is_hidden');
      document.title = '!!! –í–†–ï–ú–Ø !!!';
    }

    function saveSessionRecord() {
      const now = new Date();
      const session = {
        id: Date.now(),
        date: now.toISOString(),
        dateStr: now.toLocaleDateString(),
        timeStr: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        duration: Math.round(config.total_seconds / 60) + '–º'
      };
      const history = JSON.parse(localStorage.getItem('pomo_history') || '[]');
      history.push(session);
      localStorage.setItem('pomo_history', JSON.stringify(history));
      
      renderToday();
    }

    function triggerEmojiAnimation() {
      const emoji = document.createElement('div');
      emoji.className = 'flying-emoji';
      emoji.textContent = '‚úÖ';
      document.body.appendChild(emoji);
      setTimeout(() => emoji.remove(), 1500);
    }

    function renderToday() {
      const history = JSON.parse(localStorage.getItem('pomo_history') || '[]');
      const todayStr = new Date().toLocaleDateString();
      const container = document.getElementById('today_list');
      
      const todaySessions = history.filter(s => s.dateStr === todayStr);
      
      // --- –†–∞—Å—á–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ---
      const totalMinutes = todaySessions.reduce((acc, s) => acc + parseInt(s.duration), 0);
      const statsElem = document.getElementById('focus_stats');
      if (totalMinutes > 0) {
        const h = Math.floor(totalMinutes / 60);
        const m = totalMinutes % 60;
        const timeString = h > 0 ? `${h} —á ${m} –º–∏–Ω` : `${m} –º–∏–Ω`;
        statsElem.textContent = `–í—ã —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω—ã —Å–µ–≥–æ–¥–Ω—è: ${timeString}`;
      } else {
        statsElem.textContent = '';
      }
      // ----------------------------------------

      container.innerHTML = todaySessions
        .map(s => `
          <div class="session_item">
            <span class="session_check">‚úÖ</span>
            <span>${s.duration}</span>
            <button class="del_btn" onclick="deleteSession(${s.id})">√ó</button>
          </div>
        `).join('');
    }

    window.deleteSession = (id) => {
      let history = JSON.parse(localStorage.getItem('pomo_history') || '[]');
      history = history.filter(s => s.id !== id);
      localStorage.setItem('pomo_history', JSON.stringify(history));
      renderToday();
    };

    window.toggleHistory = (show) => {
      const modal = document.getElementById('history_modal');
      modal.style.display = show ? 'block' : 'none';
      if (show) renderFullHistory();
    };

    function initHistoryChart(dates, values) {
  const chartDom = document.getElementById('history_chart');
  const myChart = echarts.init(chartDom, window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : null);
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)
  const startPercent = dates.length > 30 ? Math.floor((1 - 30 / dates.length) * 100) : 0;

  const option = {
    backgroundColor: 'transparent',
    tooltip: { trigger: 'axis', formatter: '{b}: {c} –º–∏–Ω' },
    grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
    xAxis: {
      type: 'category',
      data: dates,
      axisLabel: { color: '#64748b' }
    },
    yAxis: {
      type: 'value',
      name: '–ú–∏–Ω—É—Ç—ã',
      splitLine: { lineStyle: { type: 'dashed', color: '#334155' } }
    },
    dataZoom: [
      {
        type: 'slider',
        start: startPercent,
        end: 100,
        height: 20,
        bottom: 0,
        borderColor: 'transparent',
        fillerColor: 'rgba(99, 102, 241, 0.2)',
        handleStyle: { color: '#6366f1' }
      }
    ],
    series: [
      {
        data: values,
        type: 'bar',
        itemStyle: { color: '#6366f1', borderRadius: [4, 4, 0, 0] },
        emphasis: { itemStyle: { color: '#4f46e5' } }
      }
    ]
  };

  myChart.setOption(option);
  
  // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
  window.addEventListener('resize', () => myChart.resize());
}

function renderFullHistory() {
  const history = JSON.parse(localStorage.getItem('pomo_history') || '[]');
  const content = document.getElementById('history_content');
  
  // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–∞–º –∏ —Ä–∞—Å—á–µ—Ç —Å—É–º–º—ã
  const groups = history.reduce((acc, s) => {
    acc[s.dateStr] = acc[s.dateStr] || { sessions: [], total: 0 };
    acc[s.dateStr].sessions.push(s);
    acc[s.dateStr].total += parseInt(s.duration) || 0;
    return acc;
  }, {});

  const sortedDates = Object.keys(groups).sort((a, b) => {
      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ (–æ–±—Ä–∞—Ç–Ω–∞—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è)
      return new Date(b.split('.').reverse().join('-')) - new Date(a.split('.').reverse().join('-'));
  });

  content.innerHTML = sortedDates.map(date => {
    const dayData = groups[date];
    return `
      <div class="history_day">
        <strong>${date} ‚Äî ${formatMinutes(dayData.total)}</strong>
        <div>${dayData.sessions.map(s => `‚úÖ ${s.timeStr} (${s.duration})`).join(' ')}</div>
      </div>
    `;
  }).join('');

  // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ (—Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫)
  const chartDates = Object.keys(groups).sort((a, b) => {
      return new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-'));
  });
  const chartValues = chartDates.map(date => groups[date].total);

  initHistoryChart(chartDates, chartValues);
}

    // --- –ú–û–î–ò–§–ò–ö–ê–¶–ò–Ø –°–£–©–ï–°–¢–í–£–Æ–©–ò–• –§–£–ù–ö–¶–ò–ô ---

    function stop_everything() {
      if (config.audio_interval) {
        clearInterval(config.audio_interval);
        config.audio_interval = null;
      }
      reset();
    }

    function reset() {
      clearInterval(config.timer_interval);
      if (config.audio_interval) {
        clearInterval(config.audio_interval);
        config.audio_interval = null;
      }
      
      config.is_active = false;
      config.is_paused = false;

      el.setup_ui.classList.remove('is_hidden');
      el.btn_main.classList.remove('is_hidden', 'btn_outline');
      el.btn_main.classList.add('btn_primary');
      el.btn_main.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å';
      el.btn_reset.classList.add('is_hidden');
      el.btn_restart.classList.add('is_hidden');
      el.btn_ok.classList.add('is_hidden');

      const m = parseInt(el.min.value) || 0;
      const s = parseInt(el.sec.value) || 0;
      update_view((m * 60) + s);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    el.btn_main.onclick = () => {
      if (config.is_active && !config.is_paused) pause();
      else start();
    };

    el.btn_reset.onclick = reset;
    
    el.btn_restart.onclick = () => {
      clearInterval(config.timer_interval);
      config.is_paused = false;
      start();
    };

    el.btn_ok.onclick = () => {
          triggerEmojiAnimation();
          stop_everything();
        };

    const sync_input = () => {
      if (!config.is_active) {
        const m = parseInt(el.min.value) || 0;
        const s = parseInt(el.sec.value) || 0;
        update_view((m * 60) + s);
      }
    };

    el.min.oninput = sync_input;
    el.sec.oninput = sync_input;
    renderToday();

        window.toggleManual = (show) => {
      const modal = document.getElementById('manual_modal');
      modal.style.display = show ? 'flex' : 'none';
      if (show) document.getElementById('manual_mins').focus();
    };

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä—É—á–Ω–æ–π —Å–µ—Å—Å–∏–∏
    window.addManualSession = () => {
      const mins = parseInt(document.getElementById('manual_mins').value);
      if (!mins || mins <= 0) return;

      const now = new Date();
      const session = {
        id: Date.now(),
        date: now.toISOString(),
        dateStr: now.toLocaleDateString(),
        timeStr: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        duration: mins + '–º'
      };

      const history = JSON.parse(localStorage.getItem('pomo_history') || '[]');
      history.push(session);
      localStorage.setItem('pomo_history', JSON.stringify(history));
      
      toggleManual(false);
      renderToday();
      triggerEmojiAnimation();
    };
    // --- –ò–ú–ü–û–†–¢ / –≠–ö–°–ü–û–†–¢ ---

    window.exportSessions = () => {
      const data = localStorage.getItem('pomo_history') || '[]';
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `pomo_sessions_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    };

    window.importSessions = (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const content = e.target.result;
          JSON.parse(content); // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å JSON

          const confirmOverwrite = confirm("–í–Ω–∏–º–∞–Ω–∏–µ! –í—Å–µ —Ç–µ–∫—É—â–∏–µ —Å–µ—Å—Å–∏–∏ –±—É–¥—É—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–µ–Ω—ã –∏ –∑–∞–º–µ–Ω–µ–Ω—ã –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ñ–∞–π–ª–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?");
          
          if (confirmOverwrite) {
            localStorage.setItem('pomo_history', content);
            renderToday();
            renderFullHistory();
            alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã");
          }
        } catch (err) {
          alert("–û—à–∏–±–∫–∞: –í—ã–±—Ä–∞–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–∞–π–ª JSON");
        }
        event.target.value = ''; // –°–±—Ä–æ—Å –∏–Ω–ø—É—Ç–∞
      };
      reader.readAsText(file);
    };
  </script>

    <div id="manual_modal" class="history_overlay" style="display: none; align-items: center; justify-content: center;">
    <div class="timer_card" style="margin: auto;">
      <div class="timer_title">–î–æ–±–∞–≤–∏—Ç—å –º–∏–Ω—É—Ç—ã</div>
      <input type="number" id="manual_mins" class="number_input" value="25" style="margin-bottom: 20px; width: 100%;">
      <div class="controls_layout">
        <button class="btn btn_primary" onclick="addManualSession()">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="btn btn_outline" onclick="toggleManual(false)">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

</body>
</html>
