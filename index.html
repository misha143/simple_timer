<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Таймер</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
  <style>
    /* --- Сброс и базовые стили --- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg_color: #f8fafc;
      --card_bg: #ffffff;
      --text_main: #0f172a;
      --text_muted: #64748b;
      --accent_color: #6366f1;
      --accent_hover: #4f46e5;
      --success_color: #10b981;
      --danger_color: #ef4444;
      --border_color: #e2e8f0;
      --shadow_lg: 0 10px 15px -3px rgba(0,0,0,0.1);
      --radius: 20px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg_color: #020617;
        --card_bg: #1e293b;
        --text_main: #f1f5f9;
        --text_muted: #94a3b8;
        --border_color: #334155;
      }
    }

    .page_body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg_color);
      color: var(--text_main);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      transition: background-color 0.3s ease;
    }

    /* --- Компоненты --- */
    .timer_card {
      background-color: var(--card_bg);
      padding: 32px;
      border-radius: var(--radius);
      box-shadow: var(--shadow_lg);
      border: 1px solid var(--border_color);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .timer_title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text_muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 24px;
    }

    /* Секция ввода */
    .inputs_row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .input_unit {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field_label {
      font-size: 12px;
      color: var(--text_muted);
      font-weight: 600;
    }

    .number_input {
      width: 80px;
      padding: 12px;
      border: 2px solid var(--border_color);
      border-radius: 12px;
      background: transparent;
      color: var(--text_main);
      font-size: 20px;
      text-align: center;
      font-weight: 600;
      outline: none;
    }

    .number_input:focus {
      border-color: var(--accent_color);
    }

    .input_separator {
      font-size: 24px;
      font-weight: 700;
      color: var(--border_color);
      margin-top: 20px;
    }

    /* Табло */
    .time_display {
      margin-bottom: 32px;
    }

  .time_numbers {
    font-family: 'Roboto Mono', monospace; /* Замена шрифта на Mono */
    font-size: 80px;
    font-weight: 700;
    line-height: 1;
  }

  /* Список сессий под таймером */
  .today_sessions {
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px dashed var(--border_color);
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
  }
  .session_item {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 10px;
    color: var(--text_muted);
    position: relative;
  }
  .session_check { font-size: 20px; cursor: default; }
  .del_btn {
    position: absolute;
    top: -5px; right: -5px;
    background: var(--danger_color);
    color: white;
    border-radius: 50%;
    width: 14px; height: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 8px; cursor: pointer; border: none;
  }

  /* Анимация эмодзи */
  .flying-emoji {
    position: fixed;
    bottom: 50%;
    left: 50%;
    font-size: 50px;
    z-index: 9999;
    pointer-events: none;
    animation: flyUpAndFade 1.5s ease-out forwards;
  }
  @keyframes flyUpAndFade {
    0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
    30% { transform: translate(-50%, -100px) scale(1.2); opacity: 1; }
    100% { transform: translate(-50%, -250px) scale(1); opacity: 0; }
  }

  /* Стили для Истории */
  .history_overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg_color); z-index: 100;
    padding: 20px; overflow-y: auto; display: none;
  }
  .history_layout {
    display: flex;
    gap: 30px;
    flex-wrap: wrap; /* Для мобильных устройств */
  }
  #history_content { flex: 1; min-width: 300px; }
  #history_chart { flex: 1; min-width: 300px; height: 400px; }
  .history_header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .history_day { margin-bottom: 15px; text-align: left; }
  .view_history_btn { margin-top: 15px; font-size: 12px; color: var(--accent_color); cursor: pointer; text-decoration: underline; }

    /* Кнопки */
    .controls_layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .btn {
      padding: 16px;
      border: none;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:active {
      transform: scale(0.96);
    }

    .btn_full {
      grid-column: span 2;
    }

    .btn_primary {
      background-color: var(--accent_color);
      color: white;
    }

    .btn_outline {
      background-color: transparent;
      border: 2px solid var(--border_color);
      color: var(--text_main);
    }

    .btn_success {
      background-color: var(--success_color);
      color: white;
    }

    .is_hidden {
      display: none !important;
    }
        .quick_actions {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 16px 0;
      flex-wrap: wrap;
    }

    .btn_mini {
      padding: 8px 14px;
      border: 1px solid var(--border_color);
      border-radius: 20px;
      background: var(--bg_color);
      color: var(--text_muted);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn_mini:hover {
      border-color: var(--accent_color);
      color: var(--accent_color);
      transform: translateY(-1px);
    }
    
    .btn_mini.manual {
      border-style: dashed;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

</head>
<body class="page_body">

  <main class="timer_card">
    <div class="timer_title">Simple Timer</div>

    <!-- Ввод минут и секунд -->
    <div class="inputs_row" id="setup_ui">
      <div class="input_unit">
        <label class="field_label">Мин</label>
        <input type="number" id="inp_min" class="number_input" value="25" min="0" max="999">
      </div>
      
      <div class="input_separator">:</div>

      <div class="input_unit">
        <label class="field_label">Сек</label>
        <input type="number" id="inp_sec" class="number_input" value="0" min="0" max="59">
      </div>
    </div>

    <!-- Табло -->
    <div class="time_display">
      <span class="time_numbers" id="display_val">25:00</span>
    </div>

    <!-- Управление -->
    <div class="controls_layout">
      <button id="btn_main" class="btn btn_primary btn_full">Запустить</button>
      <button id="btn_reset" class="btn btn_outline is_hidden">Сброс</button>
      <button id="btn_restart" class="btn btn_outline is_hidden">Повторить</button>
      <button id="btn_ok" class="btn btn_success btn_full is_hidden">Остановить звук (ОК)</button>
    </div>

    <div id="focus_stats" style="margin-top: 24px; font-size: 14px; font-weight: 600;"></div>
    <div id="today_list" class="today_sessions"></div>
    
    <!-- Панель быстрого добавления -->
    <div class="quick_actions">
      <button class="btn_mini" onclick="quickAdd(25)">+25м</button>
      <button class="btn_mini" onclick="quickAdd(15)">+15м</button>
      <button class="btn_mini" onclick="quickAdd(10)">+10м</button>
      <button class="btn_mini" onclick="quickAdd(5)">+5м</button>
      <button class="btn_mini manual" onclick="toggleManual(true)">Вручную...</button>
    </div>

    <div class="view_history_btn" onclick="toggleHistory(true)">История всех дней</div>
  </main>

  <!-- Окно истории -->
  <div id="history_modal" class="history_overlay">
    <div class="history_header">
      <div style="display: flex; flex-direction: column; gap: 4px;">
        <h2>История сессий</h2>
        <div style="display: flex; gap: 10px;">
          <span class="view_history_btn" onclick="exportSessions()">Экспорт JSON</span>
          <span class="view_history_btn" onclick="document.getElementById('import_file').click()">Импорт JSON</span>
          <input type="file" id="import_file" style="display:none" accept=".json" onchange="importSessions(event)">
        </div>
      </div>
      <button class="btn btn_outline" onclick="toggleHistory(false)">Закрыть</button>
    </div>
    <div class="history_layout">
      <div id="history_content"></div>
      <div id="history_chart"></div>
    </div>
  </div>


  <script>
    function formatMinutes(totalMinutes) {
  const h = Math.floor(totalMinutes / 60);
  const m = totalMinutes % 60;
  return h > 0 ? `${h} ч ${m} мин` : `${m} мин`;
}

    // Глобальное состояние
    let config = {
      total_seconds: 0,
      endTime: 0, // Добавлено: метка времени окончания
      timer_interval: null,
      is_active: false,
      is_paused: false,
      audio_ctx: null,
      audio_interval: null
    };

    let chartInstance = null;

    window.addEventListener('resize', () => {
      if (chartInstance) {
        chartInstance.resize();
      }
    });

    // Элементы
    const el = {
      min: document.getElementById('inp_min'),
      sec: document.getElementById('inp_sec'),
      display: document.getElementById('display_val'),
      btn_main: document.getElementById('btn_main'),
      btn_reset: document.getElementById('btn_reset'),
      btn_restart: document.getElementById('btn_restart'),
      btn_ok: document.getElementById('btn_ok'),
      setup_ui: document.getElementById('setup_ui')
    };

    // Звуковые файлы
    const soundGo = new Audio('go.mp3');
    const soundWin = new Audio('terwin.mp3');
    const c4_explode1 = new Audio('c4_explode1.mp3');

    /**
     * Форматирование времени и обновление заголовка
     */
    function update_view(s) {
      const mins = Math.floor(s / 60);
      const secs = s % 60;
      const formatted = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      el.display.textContent = formatted;
      
      if (config.is_active && !config.is_paused) {
        document.title = `(${formatted}) Таймер`;
      } else if (config.is_paused) {
        document.title = `[Пауза] ${formatted}`;
      } else {
        document.title = 'Таймер';
      }
    }

    /**
     * Звук через Web Audio API
     */
    function play_beep() {
      // Гарантируем наличие контекста
      if (!config.audio_ctx) {
        config.audio_ctx = new (window.AudioContext || window.webkitAudioContext)();
      }

      const beep = () => {
        // КРИТИЧНО: Пытаемся разбудить контекст, если он уснул
        if (config.audio_ctx.state === 'suspended') {
          config.audio_ctx.resume().then(() => {
            // Рекурсивный вызов или просто продолжение, 
            // но для простоты лучше просто запускать осциллятор после resume
            runOscillator();
          }).catch(e => console.log(e));
        } else {
          runOscillator();
        }
      };

      const runOscillator = () => {
        const osc = config.audio_ctx.createOscillator();
        const gain = config.audio_ctx.createGain();
        osc.connect(gain);
        gain.connect(config.audio_ctx.destination);
        
        osc.frequency.value = 660;
        // Важно: используем currentTime безопасно
        const now = config.audio_ctx.currentTime;
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
        
        osc.start(now);
        osc.stop(now + 0.6);
      };

      // Первый писк
      beep();
      // Цикл писков
      config.audio_interval = setInterval(beep, 1200);
    }

    /**
     * Уведомление на рабочем столе
     */
    function send_notification() {
      if (Notification.permission === 'granted') {
        // Проверяем поддержку конструктора (на всякий случай для старых Android Webview)
        try {
          const n = new Notification('Время вышло!', {
            body: 'Нажмите, чтобы остановить таймер',
            requireInteraction: true, 
            silent: true,
            tag: 'timer_finished' // Добавляем тег, чтобы не дублировать уведомления
          });

          // Если пользователь нажал на само уведомление — останавливаем
          n.onclick = () => {
            window.focus();
            triggerEmojiAnimation();
            stop_everything();
            n.close();
          };

        } catch (e) {
          console.log('Notification error:', e);
        }
      }
    }

    function initAudioContext() {
      if (!config.audio_ctx) {
        config.audio_ctx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (config.audio_ctx.state === 'suspended') {
        config.audio_ctx.resume();
      }
    }
    function toggleInputs(disabled) {
      el.min.disabled = disabled;
      el.sec.disabled = disabled;
    }

    function start() {
      clearInterval(config.timer_interval);
      
      initAudioContext();

      if (Notification.permission === 'default') {
        Notification.requestPermission();
      }

      if (!config.is_paused) {
        const m = parseInt(el.min.value) || 0;
        const s = parseInt(el.sec.value) || 0;
        config.total_seconds = (m * 60) + s;
        
        if (config.total_seconds <= 0) return;

        config.endTime = Date.now() + (config.total_seconds * 1000);

        soundGo.play().catch(e => console.log("Audio play blocked (user interaction needed)"));
      } else {
        config.endTime = Date.now() + (config.remaining_seconds * 1000);
      }

      config.is_active = true;
      config.is_paused = false;

      toggleInputs(true);
      
      el.btn_main.textContent = 'Пауза';
      el.btn_main.classList.replace('btn_primary', 'btn_outline');
      el.setup_ui.classList.add('is_hidden');
      el.btn_reset.classList.remove('is_hidden');
      el.btn_restart.classList.remove('is_hidden');

      config.timer_interval = setInterval(() => {
        const now = Date.now();
        const left = Math.ceil((config.endTime - now) / 1000);
        
        config.remaining_seconds = left;

        if (left <= 0) {
          update_view(0);
          finish();
        } else {
          update_view(left);
        }
      }, 200);
    }

    function pause() {
      clearInterval(config.timer_interval);
      config.is_paused = true;
      // config.remaining_seconds уже обновлен в интервале
      el.btn_main.textContent = 'Продолжить';
      el.btn_main.classList.replace('btn_outline', 'btn_primary');
      update_view(config.remaining_seconds);
    }

function finish() {
      clearInterval(config.timer_interval);
      config.is_active = false;
      saveSessionRecord(); 
      
      // Вибрация для Android (200мс вибро, 100мс пауза, 200мс вибро)
      if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200, 100, 500]);
      }

      c4_explode1.play().catch(e => console.log("Audio play blocked"));
      soundWin.play().catch(e => console.log("Audio play blocked"));
      
      play_beep();
      send_notification();
      
      el.btn_main.classList.add('is_hidden');
      el.btn_reset.classList.add('is_hidden');
      el.btn_restart.classList.add('is_hidden');
      el.btn_ok.classList.remove('is_hidden');
      document.title = '!!! ВРЕМЯ !!!';
    }

    function saveSessionRecord() {
      const now = new Date();
      // FIX: Добавляем isoDateKey для корректной сортировки независимо от локали
      // Формируем YYYY-MM-DD вручную, чтобы избежать проблем с часовыми поясами ISO строки
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const isoDateKey = `${year}-${month}-${day}`;

      const session = {
        id: Date.now(),
        date: now.toISOString(), // Полная метка для истории
        isoDateKey: isoDateKey,  // Ключ для группировки (FIX)
        dateStr: now.toLocaleDateString(), // Для отображения пользователю
        timeStr: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        duration: Math.round(config.total_seconds / 60) + 'м'
      };
      
      const history = JSON.parse(localStorage.getItem('pomo_history') || '[]');
      history.push(session);
      localStorage.setItem('pomo_history', JSON.stringify(history));
      
      renderToday();
    }

    function triggerEmojiAnimation() {
      const emoji = document.createElement('div');
      emoji.className = 'flying-emoji';
      emoji.textContent = '✅';
      document.body.appendChild(emoji);
      setTimeout(() => emoji.remove(), 1500);
    }
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    function renderToday() {
      const history = JSON.parse(localStorage.getItem('pomo_history') || '[]');
      const todayStr = new Date().toLocaleDateString();
      const container = document.getElementById('today_list');
      
      const todaySessions = history.filter(s => s.dateStr === todayStr);
      
      // FIX: Защита от NaN, если duration поврежден
      const totalMinutes = todaySessions.reduce((acc, s) => acc + (parseInt(s.duration) || 0), 0);
      const statsElem = document.getElementById('focus_stats');
      
      if (totalMinutes > 0) {
        const h = Math.floor(totalMinutes / 60);
        const m = totalMinutes % 60;
        const timeString = h > 0 ? `${h} ч ${m} мин` : `${m} мин`;
        statsElem.textContent = `Вы сфокусированы сегодня: ${timeString}`;
      } else {
        statsElem.textContent = '';
      }

      // FIX: Добавлен escapeHtml для защиты от XSS
      container.innerHTML = todaySessions
        .map(s => `
          <div class="session_item">
            <span class="session_check">✅</span>
            <span>${escapeHtml(s.duration)}</span>
            <button class="del_btn" onclick="deleteSession(${s.id})">×</button>
          </div>
        `).join('');
    }  

    window.deleteSession = (id) => {
      let history = JSON.parse(localStorage.getItem('pomo_history') || '[]');
      history = history.filter(s => s.id !== id);
      localStorage.setItem('pomo_history', JSON.stringify(history));
      renderToday();
    };

    window.toggleHistory = (show) => {
      const modal = document.getElementById('history_modal');
      modal.style.display = show ? 'block' : 'none';
      if (show) renderFullHistory();
    };

function initHistoryChart(dates, values) {
      const chartDom = document.getElementById('history_chart');
      
      // FIX: Если график уже есть, уничтожаем старый экземпляр перед созданием нового
      if (chartInstance) {
        chartInstance.dispose();
      }

      // FIX: Присваиваем глобальной переменной
      chartInstance = echarts.init(chartDom, window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : null);
      
      const startPercent = dates.length > 30 ? Math.floor((1 - 30 / dates.length) * 100) : 0;

      const option = {
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis', formatter: '{b}: {c} мин' },
        grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
        xAxis: {
          type: 'category',
          data: dates,
          axisLabel: { color: '#64748b' }
        },
        yAxis: {
          type: 'value',
          name: 'Минуты',
          splitLine: { lineStyle: { type: 'dashed', color: '#334155' } }
        },
        dataZoom: [
          {
            type: 'slider',
            start: startPercent,
            end: 100,
            height: 20,
            bottom: 0,
            borderColor: 'transparent',
            fillerColor: 'rgba(99, 102, 241, 0.2)',
            handleStyle: { color: '#6366f1' }
          }
        ],
        series: [
          {
            data: values,
            type: 'bar',
            itemStyle: { color: '#6366f1', borderRadius: [4, 4, 0, 0] },
            emphasis: { itemStyle: { color: '#4f46e5' } }
          }
        ]
      };

      chartInstance.setOption(option);
      
      // FIX: Удален addEventListener внутри функции, так как он теперь глобальный
    }

function renderFullHistory() {
      const history = JSON.parse(localStorage.getItem('pomo_history') || '[]');
      const content = document.getElementById('history_content');
      
      const groups = history.reduce((acc, s) => {
        let key = s.isoDateKey;
        if (!key) {
           try {
             key = s.date ? s.date.split('T')[0] : s.dateStr;
           } catch(e) { key = s.dateStr; }
        }

        acc[key] = acc[key] || { sessions: [], total: 0, displayDate: s.dateStr };
        acc[key].sessions.push(s);
        acc[key].total += parseInt(s.duration) || 0; // FIX: защита от NaN
        if(s.dateStr) acc[key].displayDate = s.dateStr; 
        
        return acc;
      }, {});

      const sortedKeys = Object.keys(groups).sort((a, b) => b.localeCompare(a));

      // FIX: Добавлен escapeHtml во всех местах вывода пользовательских данных
      content.innerHTML = sortedKeys.map(key => {
        const dayData = groups[key];
        return `
          <div class="history_day">
            <strong>${escapeHtml(dayData.displayDate)} — ${formatMinutes(dayData.total)}</strong>
            <div>${dayData.sessions.map(s => `✅ ${escapeHtml(s.timeStr)} (${escapeHtml(s.duration)})`).join(' ')}</div>
          </div>
        `;
      }).join('');

      const chartKeys = [...sortedKeys].reverse(); 
      const chartDates = chartKeys.map(k => groups[k].displayDate);
      const chartValues = chartKeys.map(k => groups[k].total);

      initHistoryChart(chartDates, chartValues);
    }

    // --- МОДИФИКАЦИЯ СУЩЕСТВУЮЩИХ ФУНКЦИЙ ---

    function stop_everything() {
      if (config.audio_interval) {
        clearInterval(config.audio_interval);
        config.audio_interval = null;
      }
      reset();
    }

    function reset() {
      clearInterval(config.timer_interval);
      if (config.audio_interval) {
        clearInterval(config.audio_interval);
        config.audio_interval = null;
      }
      
      config.is_active = false;
      config.is_paused = false;
      config.endTime = 0; // Сброс
      toggleInputs(false);


      el.setup_ui.classList.remove('is_hidden');
      el.btn_main.classList.remove('is_hidden', 'btn_outline');
      el.btn_main.classList.add('btn_primary');
      el.btn_main.textContent = 'Запустить';
      el.btn_reset.classList.add('is_hidden');
      el.btn_restart.classList.add('is_hidden');
      el.btn_ok.classList.add('is_hidden');

      const m = parseInt(el.min.value) || 0;
      const s = parseInt(el.sec.value) || 0;
      update_view((m * 60) + s);
    }

    // Обработчики кнопок
    el.btn_main.onclick = () => {
      if (config.is_active && !config.is_paused) pause();
      else start();
    };

    el.btn_reset.onclick = reset;
    
    el.btn_restart.onclick = () => {
      clearInterval(config.timer_interval);
      config.is_paused = false;
      start();
    };

    el.btn_ok.onclick = () => {
          triggerEmojiAnimation();
          stop_everything();
        };

    const sync_input = () => {
      if (!config.is_active) {
        const m = parseInt(el.min.value) || 0;
        const s = parseInt(el.sec.value) || 0;
        update_view((m * 60) + s);
      }
    };

    el.min.oninput = sync_input;
    el.sec.oninput = sync_input;
    renderToday();

    // --- Логика отслеживания наступления нового дня ---
    let lastRenderedDate = new Date().toLocaleDateString();

    function checkAndRefreshDay() {
      const currentDate = new Date().toLocaleDateString();
      if (currentDate !== lastRenderedDate) {
        lastRenderedDate = currentDate;
        renderToday();
        console.log("Новый день наступил, список очищен");
      }
    }

    // Проверка каждые 15 минут
    setInterval(checkAndRefreshDay, 15 * 60 * 1000);

    // Дополнительная проверка при активации вкладки (после сна или переключения окон)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        checkAndRefreshDay();
      }
    });

        window.toggleManual = (show) => {
      const modal = document.getElementById('manual_modal');
      modal.style.display = show ? 'flex' : 'none';
      if (show) document.getElementById('manual_mins').focus();
    };

    // Общая функция сохранения (Logic Core)
    function saveLog(mins) {
      if (!mins || mins <= 0) return;

      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const isoDateKey = `${year}-${month}-${day}`;

      const session = {
        id: Date.now(),
        date: now.toISOString(),
        isoDateKey: isoDateKey,
        dateStr: now.toLocaleDateString(),
        timeStr: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        duration: mins + 'м'
      };

      const history = JSON.parse(localStorage.getItem('pomo_history') || '[]');
      history.push(session);
      localStorage.setItem('pomo_history', JSON.stringify(history));
      
      renderToday();
      triggerEmojiAnimation();
    }

    // Быстрое добавление через кнопки
    window.quickAdd = (mins) => {
      saveLog(mins);
    };

    // Добавление через модальное окно
    window.addManualSession = () => {
      const input = document.getElementById('manual_mins');
      const mins = parseInt(input.value);
      
      if (mins > 0) {
        saveLog(mins);
        toggleManual(false);
      }
    };

    window.exportSessions = () => {
      const data = localStorage.getItem('pomo_history') || '[]';
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `pomo_sessions_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    };

    window.importSessions = (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const content = e.target.result;
          const data = JSON.parse(content);

          if (!Array.isArray(data)) {
            throw new Error("Файл должен содержать массив данных (JSON Array)");
          }

          // FIX: Более строгая проверка структуры данных перед сохранением
          const isValid = data.every(item => 
            item && 
            typeof item === 'object' && 
            Object.prototype.hasOwnProperty.call(item, 'duration') &&
            Object.prototype.hasOwnProperty.call(item, 'date')
          );

          if (!isValid) {
            throw new Error("Структура данных некорректна. Требуются поля 'date' и 'duration'.");
          }

          const confirmOverwrite = confirm("Внимание! Все текущие сессии будут удалены. Продолжить?");
          
          if (confirmOverwrite) {
            localStorage.setItem('pomo_history', JSON.stringify(data));
            renderToday();
            renderFullHistory();
            alert("Данные успешно импортированы");
          }
        } catch (err) {
          console.error(err);
          alert("Ошибка импорта: " + err.message);
        }
        event.target.value = ''; 
      };
      reader.readAsText(file);
    };
  </script>

    <div id="manual_modal" class="history_overlay" style="display: none; align-items: center; justify-content: center;">
    <div class="timer_card" style="margin: auto;">
      <div class="timer_title">Добавить минуты</div>
      <input type="number" id="manual_mins" class="number_input" value="25" style="margin-bottom: 20px; width: 100%;">
      <div class="controls_layout">
        <button class="btn btn_primary" onclick="addManualSession()">Добавить</button>
        <button class="btn btn_outline" onclick="toggleManual(false)">Отмена</button>
      </div>
    </div>
  </div>

</body>
</html>