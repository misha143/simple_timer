<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Timer v2</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.7);
      --accent: #6366f1;
      --accent-glow: rgba(99, 102, 241, 0.4);
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --danger: #ef4444;
      --success: #10b981;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      background-image: radial-gradient(circle at 50% -20%, #1e293b, #0f172a);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow: hidden;
    }

    .timer-container {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 40px;
      border-radius: 32px;
      width: 100%;
      max-width: 380px;
      text-align: center;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      position: relative;
    }

    /* Прогресс-кольцо */
    .progress-area {
      position: relative;
      width: 220px;
      height: 220px;
      margin: 0 auto 30px;
    }

    .progress-svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }

    .progress-bg {
      fill: none;
      stroke: rgba(255, 255, 255, 0.05);
      stroke-width: 8;
    }

    .progress-bar {
      fill: none;
      stroke: var(--accent);
      stroke-width: 8;
      stroke-linecap: round;
      stroke-dasharray: 628;
      stroke-dashoffset: 0;
      transition: stroke-dashoffset 0.3s linear, stroke 0.3s;
    }

    .time-display {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .time-numbers {
      font-size: 48px;
      font-weight: 800;
      letter-spacing: -1px;
    }

    /* Поля ввода */
    .inputs-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }

    .input-box {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .input-box span {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 600;
    }

    .number-input {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 24px;
      font-weight: 600;
      width: 70px;
      padding: 10px;
      border-radius: 12px;
      text-align: center;
      outline: none;
    }

    .number-input:focus { border-color: var(--accent); }

    /* Кнопки */
    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: 0 4px 15px var(--accent-glow);
    }

    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px var(--accent-glow); }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      margin-top: 10px;
    }

    .btn-secondary:hover { background: rgba(255, 255, 255, 0.1); }

    .btn-stop {
      background: var(--danger);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    .hidden { display: none !important; }

    /* Анимация при завершении */
    .is-finished .progress-bar { stroke: var(--danger); }
    .is-finished .time-numbers { color: var(--danger); animation: shake 0.5s infinite; }

    @keyframes shake {
      0%, 100% { transform: translate(0,0); }
      25% { transform: translate(-2px, 0); }
      75% { transform: translate(2px, 0); }
    }
  </style>
</head>
<body>

  <div class="timer-container" id="timer_card">
    <div class="progress-area">
      <svg class="progress-svg" viewBox="0 0 210 210">
        <circle class="progress-bg" cx="105" cy="105" r="100"></circle>
        <circle id="progress_bar" class="progress-bar" cx="105" cy="105" r="100"></circle>
      </svg>
      <div class="time-display">
        <div class="time-numbers" id="display_val">01:00</div>
      </div>
    </div>

    <div id="setup_ui">
      <div class="inputs-group">
        <div class="input-box">
          <span>Мин</span>
          <input type="number" id="inp_min" class="number-input" value="1" min="0">
        </div>
        <div class="input-box">
          <span>Сек</span>
          <input type="number" id="inp_sec" class="number-input" value="0" min="0" max="59">
        </div>
      </div>
      <button id="btn_start" class="btn btn_primary">Начать работу</button>
    </div>

    <div id="active_ui" class="hidden">
      <button id="btn_pause" class="btn btn_primary">Пауза</button>
      <button id="btn_reset" class="btn btn_secondary">Сбросить</button>
    </div>

    <div id="finish_ui" class="hidden">
      <button id="btn_stop_sound" class="btn btn-primary btn-stop">Остановить (ОК)</button>
    </div>
  </div>

  <script>
    const state = {
      total: 0,
      remain: 0,
      timer: null,
      audioCtx: null,
      audioInterval: null,
      status: 'idle', // idle, running, paused, finished
      notification: null
    };

    const el = {
      min: document.getElementById('inp_min'),
      sec: document.getElementById('inp_sec'),
      display: document.getElementById('display_val'),
      progress: document.getElementById('progress_bar'),
      card: document.getElementById('timer_card'),
      // Секции
      setup: document.getElementById('setup_ui'),
      active: document.getElementById('active_ui'),
      finish: document.getElementById('finish_ui'),
      // Кнопки
      btnStart: document.getElementById('btn_start'),
      btnPause: document.getElementById('btn_pause'),
      btnReset: document.getElementById('btn_reset'),
      btnStop: document.getElementById('btn_stop_sound')
    };

    // Константа для круга (2 * PI * R)
    const CIRCUMFERENCE = 2 * Math.PI * 100;

    function updateDisplay() {
      const m = Math.floor(state.remain / 60);
      const s = state.remain % 60;
      const str = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
      el.display.textContent = str;
      
      // Прогресс бар
      const offset = CIRCUMFERENCE - (state.remain / state.total) * CIRCUMFERENCE;
      el.progress.style.strokeDashoffset = isNaN(offset) ? 0 : offset;

      document.title = state.status === 'running' ? `${str} - Таймер` : 'Smart Timer';
    }

    function initAudio() {
      if (!state.audioCtx) {
        state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (state.audioCtx.state === 'suspended') {
        state.audioCtx.resume();
      }
    }

    function playSound() {
      initAudio();
      const beep = () => {
        const osc = state.audioCtx.createOscillator();
        const gain = state.audioCtx.createGain();
        osc.connect(gain);
        gain.connect(state.audioCtx.destination);
        osc.frequency.setValueAtTime(880, state.audioCtx.currentTime); 
        gain.gain.setValueAtTime(0.2, state.audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, state.audioCtx.currentTime + 0.5);
        osc.start();
        osc.stop(state.audioCtx.currentTime + 0.5);
      };
      beep();
      state.audioInterval = setInterval(beep, 1000);
      
      if ("vibrate" in navigator) navigator.vibrate([500, 300, 500]);
    }

    function showNotification() {
      if (Notification.permission === 'granted') {
        state.notification = new Notification('Время вышло!', {
          body: 'Нажмите, чтобы остановить звук или просто закройте (X)',
          icon: 'https://cdn-icons-png.flaticon.com/512/2523/2523141.png',
          requireInteraction: true,
          tag: 'timer-alert' // Предотвращает дублирование
        });

        // 1. Клик по самому уведомлению
        state.notification.onclick = () => {
          window.focus();
          stopAlarm();
          state.notification.close();
        };

        // 2. КРЕСТИК (Закрытие уведомления)
        // ВАЖНО: onclose срабатывает, когда пользователь смахивает или жмет X
        state.notification.onclose = () => {
          stopAlarm();
        };
      }
    }

    function startTimer() {
      initAudio(); // Важно вызвать при клике!
      
      if (state.status === 'idle') {
        const m = parseInt(el.min.value) || 0;
        const s = parseInt(el.sec.value) || 0;
        state.total = (m * 60) + s;
        if (state.total <= 0) return;
        state.remain = state.total;
        
        if (Notification.permission !== 'granted') {
          Notification.requestPermission();
        }
      }

      state.status = 'running';
      toggleUI();
      
      state.timer = setInterval(() => {
        state.remain--;
        updateDisplay();
        if (state.remain <= 0) finish();
      }, 1000);
    }

    function pauseTimer() {
      state.status = 'paused';
      clearInterval(state.timer);
      el.btnPause.textContent = 'Продолжить';
      document.title = '[Пауза] ' + el.display.textContent;
    }

    function finish() {
      clearInterval(state.timer);
      state.status = 'finished';
      el.card.classList.add('is-finished');
      toggleUI();
      playSound();
      showNotification();
    }

    function stopAlarm() {
      if (state.audioInterval) {
        clearInterval(state.audioInterval);
        state.audioInterval = null;
      }
      if (state.notification) {
        state.notification.onclose = null; // Предотвращаем зацикливание при программном закрытии
        state.notification.close();
      }
      resetTimer();
    }

    function resetTimer() {
      clearInterval(state.timer);
      clearInterval(state.audioInterval);
      state.status = 'idle';
      state.remain = 0;
      el.card.classList.remove('is-finished');
      el.btnPause.textContent = 'Пауза';
      toggleUI();
      updateDisplay();
    }

    function toggleUI() {
      el.setup.classList.toggle('hidden', state.status !== 'idle');
      el.active.classList.toggle('hidden', state.status !== 'running' && state.status !== 'paused');
      el.finish.classList.toggle('hidden', state.status !== 'finished');
    }

    // Слушатели
    el.btnStart.onclick = startTimer;
    el.btnPause.onclick = () => state.status === 'running' ? pauseTimer() : startTimer();
    el.btnReset.onclick = resetTimer;
    el.btnStop.onclick = stopAlarm;

    // Синхронизация инпутов с табло
    [el.min, el.sec].forEach(input => {
      input.oninput = () => {
        if (state.status
